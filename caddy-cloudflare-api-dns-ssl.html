<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta http-equiv="Cache-Control" content="no-siteapp">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1, minimum-scale=1, maximum-scale=1">
<meta name="renderer" content="webkit">
<meta name="google" value="notranslate">
<meta name="robots" content="index,follow">


<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="567899.xyz">
<meta name="twitter:description" content="这家伙很赖，什么也没有留下。">
<meta name="twitter:image:src" content="https://567899.xyz/images/avatar.png">

<meta property="og:url" content="https://567899.xyz">
<meta property="og:title" content="567899.xyz">
<meta property="og:description" content="这家伙很赖，什么也没有留下。">
<meta property="og:site_name" content="567899.xyz">
<meta property="og:image" content="https://567899.xyz/images/avatar.png">
<meta property="og:type" content="website">
<meta name="robots" content="noodp">

<meta itemprop="name" content="567899.xyz">
<meta itemprop="description" content="这家伙很赖，什么也没有留下。">
<meta itemprop="image" content="https://567899.xyz/images/avatar.png">

<link rel="canonical" href="https://567899.xyz">

<link rel="shortcut icon" href="/favicon.png">
<link rel="apple-itouch-icon" href="/favicon.png">
<link rel="stylesheet" href="/bundle/index.css">
<script type="text/javascript">
    var timeSinceLang = {
        year: '年前',
        month: '个月前',
        day: '天前',
        hour: '小时前',
        minute: '分钟前',
        second: '秒前'
    };
    var root = '';
</script>


        <meta name="keywords" content="caddy,cloudflare,ssl,">
        <meta name="description" content="Caddy利用CloudFlare DNS申请泛域名证书">
        <meta name="author" content="567899.xyz">
        <title>Caddy利用CloudFlare DNS申请泛域名证书</title>
    </head>
    <body>
        <article class="container">
            <header class="header-wrap">
  <a class="index" href="/">
    <img class="logo" src="/images/avatar.png" />
    567899.xyz
  </a>
  <ul class="menu">
      <li class="menu-item"><a href="/archive.html">归档</a></li>
      <li class="menu-item"><a href="/tag.html">标签</a></li>
      <li class="menu-item"><a href="/atom.xml">订阅</a></li>
  </ul>
</header>

            <article class="main article">
                <h1 class="title">Caddy利用CloudFlare DNS申请泛域名证书</h1>
                <section class="info">
                    <span class="avatar" style="background-image: url(/images/avatar.png);"></span>
                    <a class="name" href="/about.me.html">567899.xyz</a>
                    
                    <span class="date" data-time="1554541200"><span class="from"></span></span>
                    
                    <span class="tags"><a class="tag" href="/tag/caddy/index.html">caddy</a><a class="tag" href="/tag/cloudflare/index.html">cloudflare</a><a class="tag" href="/tag/ssl/index.html">ssl</a></span>
                </section>
                <article class="content"><h3>安装Caddy</h3>

<pre><code class="language-bash">curl https://getcaddy.com | bash -s personal tls.dns.cloudflare
</code></pre>

<p>后面的<code>tls.dns.cloudflare</code>为<code>cloudflare</code>的插件，如果你是其它DNS服务商就需要替换下插件参数，比如：</p>

<pre><code class="language-bash">tls.dns.auroradns
tls.dns.azure
tls.dns.cloudflare
tls.dns.cloudxns
tls.dns.digitalocean
tls.dns.dnsimple
tls.dns.dnsmadeeasy
tls.dns.dnspod
tls.dns.dyn
tls.dns.exoscale
tls.dns.gandi
tls.dns.gandiv5
tls.dns.godaddy
tls.dns.googlecloud
tls.dns.lightsail
tls.dns.linode
tls.dns.namecheap
tls.dns.ns1
tls.dns.otc
tls.dns.ovh
tls.dns.powerdns
tls.dns.rackspace
tls.dns.rfc2136
tls.dns.route53i
tls.dns.vultr
</code></pre>

<h3>设置环境变量</h3>

<p>以下为Caddy申请通配符时所需要的DNS服务商的环境变量。</p>

<pre><code class="language-bash">#Aurora DNS by PCExtreme
AURORA_USER_ID
AURORA_KEY
AURORA_ENDPOINT(optional)

#Azure DNS
AZURE_CLIENT_ID
AZURE_CLIENT_SECRET
AZURE_SUBSCRIPTION_ID
AZURE_TENANT_ID

#Cloudflare
CLOUDFLARE_EMAIL
CLOUDFLARE_API_KEY

#CloudXNS
CLOUDXNS_API_KEY
CLOUDXNS_SECRET_KEY

#DigitalOcean
DO_AUTH_TOKEN

#DNSimple
DNSIMPLE_EMAIL
DNSIMPLE_OAUTH_TOKEN

#DNS Made Easy
DNSMADEEASY_API_KEY
DNSMADEEASY_API_SECRET
DNSMADEEASY_SANDBOX(true/false)

#DNSPod
DNSPOD_API_KEY

#DynDNS
DYN_CUSTOMER_NAME
DYN_USER_NAME
DYN_PASSWORD

#Gandi/Gandiv5
GANDI_API_KEY/GANDIV5_API_KEY

#GoDaddy
GODADDY_API_KEY
GODADDY_API_SECRET

#Google Cloud DNS    
GCE_PROJECT
GCE_DOMAIN
GOOGLE_APPLICATION_CREDENTIALS

#Lightsail by AWS
AWS_ACCESS_KEY_ID
AWS_SECRET_ACCESS_KEY
AWS_SESSION_TOKEN(optional)
DNS_ZONE(optional)

#Linode
LINODE_API_KEY

#Namecheap
NAMECHEAP_API_USER
NAMECHEAP_API_KEY

#NS1
NS1_API_KEY

#Open Telekom Cloud Managed DNS
OTC_DOMAIN_NAME
OTC_USER_NAME
OTC_PASSWORD
OTC_PROJECT_NAME
OTC_IDENTITY_ENDPOINT(optional)

#OVH
OVH_ENDPOINT
OVH_APPLICATION_KEY
OVH_APPLICATION_SECRET
OVH_CONSUMER_KEY

#PowerDNS
PDNS_API_URL
PDNS_API_KEY

#Rackspace
RACKSPACE_USER
RACKSPACE_API_KEY

#RFC2136
RFC2136_NAMESERVER
RFC2136_TSIG_ALGORITHM
RFC2136_TSIG_KEY
RFC2136_TSIG_SECRET

#Route53 by AWS    
AWS_ACCESS_KEY_ID
AWS_SECRET_ACCESS_KEY

#Vultr
VULTR_API_KEY
</code></pre>

<p>登陆CloudFlare的<a href="https://dash.cloudflare.com/profile/api-tokens">API Tokens</a> 然后下拉找到【API Keys】【Global API Key】【View】</p>

<p>再使用命令设置环境变量：</p>

<pre><code class="language-bash">export CLOUDFLARE_API_KEY=&quot;3ce7025c4ae*****35003326cad0bc1a6694f&quot;  #CloudFlare账户API
export CLOUDFLARE_EMAIL=&quot;yourname@gmail.com&quot;  #CloudFlare账户邮箱
</code></pre>

<h3>获取通配符</h3>

<p>先新建配置文件，使用命令：</p>

<p>#将域名修改为自己的，然后将下面全部一起复制到SSH客户端运行</p>

<pre><code class="language-bash">echo &quot;*.xxx.com {
tls {
    dns cloudflare
}
}&quot; &gt; Caddyfile
</code></pre>

<p>这里如果你是其它DNS服务商就需要修改dns后面的参数，也就是服务商名称，均用小写字母，可以参考步骤1安装caddy的插件参数，比如插件为tls.dns.auroradns，那就用dns auroradns参数。</p>

<p>然后启动Caddy：</p>

<pre><code class="language-bash">caddy -conf Caddyfile
</code></pre>

<p>会自动给你生成一个通配符SSL证书 Caddy自动申请SSL证书位置：</p>

<pre><code class="language-bash">/etc/ssl/caddy/acme/acme-v02.api.letsencrypt.org/sites/*.xxx.com(域名)/
</code></pre>

<p>此时你就可以使用<code>*.xxx.com.crt</code>和<code>*.xxx.com.key</code>文件为你的所有子域名配置SSL了。</p>

<p>最后证书有效期依然是3个月，到期后可以重新用此方法申请。</p>

<p>如果提示<code>WARNING: File descriptor limit 1024 is too low for production servers. At least 8192 is recommended. Fix with</code>ulimit -n 8192<code>.</code>可按提示输入以下命令</p>

<pre><code class="language-bash">ulimit -n 8192
</code></pre>
</article>
                <section class="author">
                    <div class="avatar" style="background-image: url(/images/avatar.png);"></div>
                    <a class="name" href="/about.me.html">567899.xyz</a>
                    <div class="intro">记录折腾中的点点滴滴</div>
                </section>
                <section class="recommend">
                    
                    <section class="nav prev more">
                        <div class="head">上篇文章</div>
                        <a class="link" href="/xshell6.html">最新永久激活破解Xshell6和Xftp6</a>
                    </section>
                    
                    
                    <section class="nav next more">
                        <div class="head">下篇文章</div>
                        <a class="link" href="/git-push-error.html">推送发布到GitHub及错误提示</a>
                    </section>
                    
                </section>
                
    <section id="disqus_thread"></section>
    <script type="text/javascript">
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//vvy.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>


            </article>
        </article>
        <footer class="footer">
    <span class="copyright">
        567899.xyz ©
        <script type="text/javascript">
            document.write(new Date().getFullYear());
        </script>
    </span>
    <span class="publish">Powered by <a href="http://www.chole.io/" target="_blank">Ink</a></span>
	
<script src="/js/jquery.min.js"></script>
<script type="text/javascript">
var a_idx = 0;
jQuery(document).ready(function($) {
    $("body").click(function(e) {
        var a = new Array("富强", "民主", "文明", "和谐", "自由", "平等", "公正", "法治", "爱国", "敬业", "诚信", "友善");
        var $i = $("<span/>").text(a[a_idx]);
        a_idx = (a_idx + 1) % a.length;
        var x = e.pageX,
        y = e.pageY;
        $i.css({
            "z-index": 100000000,
            "top": y - 20,
            "left": x,
            "position": "absolute",
            "font-weight": "bold",
            "color": "#FF0000"
        });
        $("body").append($i);
        $i.animate({
            "top": y - 180,
            "opacity": 0
        },
        1500,
        function() {
            $i.remove();
        });
    });
});
</script>
	
</footer>

        <script src="/bundle/index.js"></script>
    </body>
</html>
